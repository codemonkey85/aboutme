name: Deploy to GitHub Pages

# Run workflow on every push to the main branch
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths-ignore:
      - "**.md"
      - ".editorconfig"
      - '**/*.gitignore'
      - '**/*.gitattributes'
      - '**/*.yml'

jobs:
  build:
    name: Build and Deploy
    # use ubuntu-latest image to run steps on
    runs-on: ubuntu-latest

    steps:
      # uses GitHub's checkout action to checkout code form the main branch
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      # sets up .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4.3.1
        with:
          global-json-file: ./global.json

      - name: Install WASM workload
        run: dotnet workload install wasm-tools
  
      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Install Azure Developer CLI
        run: |
          curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: Authenticate with Azure
        uses: azure/login@v2.3.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Provision resources
        run: azd provision --no-prompt
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }} # Replace with your client ID
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }} # Replace with your client secret
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }} # Replace with your tenant ID

      - name: Deploy application
        run: azd deploy --no-prompt
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Logout from Azure
        run: az logout
